From f8b7620e0578ef44e8fd958d32f348b535d1ab77 Mon Sep 17 00:00:00 2001
From: Daniel Stenberg <daniel@haxx.se>
Date: Sat, 7 Oct 2017 00:11:31 +0200
Subject: [PATCH] imap: if a FETCH response has no size, don't call write
 callback

CVE-2017-1000257

Reported-by: Brian Carpenter and 0xd34db347
Also detected by OSS-Fuzz: https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=3586

Upstream-commit: 13c9a9ded3ae744a1e11cbc14e9146d9fa427040
Signed-off-by: Kamil Dudka <kdudka@redhat.com>
---
 lib/imap.c | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/lib/imap.c b/lib/imap.c
index 48af290..4deba88 100644
--- a/lib/imap.c
+++ b/lib/imap.c
@@ -1137,6 +1137,11 @@ static CURLcode imap_state_fetch_resp(struct connectdata *conn, int imapcode,
         /* the conversion from curl_off_t to size_t is always fine here */
         chunk = (size_t)filesize;
 
+      if(!chunk) {
+        /* no size, we're done with the data */
+        state(conn, IMAP_STOP);
+        return CURLE_OK;
+      }
       result = Curl_client_write(conn, CLIENTWRITE_BODY, pp->cache, chunk);
       if(result)
         return result;
-- 
2.13.6

